<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gym ‚Äî InThisWorld</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a0f;color:#e0e0f0;font-family:'Segoe UI',system-ui,sans-serif;overflow:hidden}
canvas{display:block;position:fixed;top:0;left:0}
.chat-panel{position:fixed;right:0;top:0;bottom:0;width:320px;background:rgba(10,10,25,0.92);border-left:1px solid rgba(239,68,68,0.2);z-index:20;display:flex;flex-direction:column;backdrop-filter:blur(8px)}
.chat-header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:space-between}
.chat-header h3{font-size:1rem;color:#f87171}
.chat-header .room-count{font-size:0.75rem;color:rgba(255,255,255,0.4);background:rgba(239,68,68,0.15);padding:3px 10px;border-radius:10px}
.chat-msgs{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:8px;scrollbar-width:thin;scrollbar-color:rgba(239,68,68,0.3) transparent}
.chat-msg{padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.03);font-size:0.85rem;line-height:1.5;animation:msgIn 0.3s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.chat-msg .name{font-weight:700;font-size:0.8rem;margin-bottom:2px}
.chat-msg.system{background:rgba(239,68,68,0.08);color:#f87171;font-style:italic;font-size:0.8rem}
.chat-input-wrap{padding:12px;border-top:1px solid rgba(255,255,255,0.06);display:flex;gap:8px}
.chat-input{flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:10px 14px;color:#fff;font-family:inherit;font-size:0.9rem;outline:none}
.chat-input:focus{border-color:rgba(239,68,68,0.4)}
.chat-send{background:linear-gradient(135deg,#ef4444,#dc2626);border:none;border-radius:10px;padding:10px 16px;color:#fff;font-weight:700;cursor:pointer;font-family:inherit;transition:all 0.2s}
.chat-send:hover{box-shadow:0 4px 15px rgba(239,68,68,0.4)}
.hud-top{position:fixed;top:12px;left:12px;z-index:15;display:flex;gap:10px;align-items:center}
.hud-pill{background:rgba(10,10,30,0.85);border:1px solid rgba(239,68,68,0.25);border-radius:20px;padding:8px 16px;font-size:0.85rem;font-weight:600;backdrop-filter:blur(6px)}
.hud-pill .emoji{margin-right:6px}
.crosshair{position:fixed;top:50%;left:calc(50% - 160px);transform:translate(-50%,-50%);width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,0.3);z-index:12;pointer-events:none}
.splash{position:fixed;inset:0;z-index:200;background:radial-gradient(ellipse at 50% 40%,#200a0a,#050510);display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:20px}
.splash h1{font-size:clamp(2rem,5vw,3.5rem);background:linear-gradient(135deg,#ef4444,#f97316,#fbbf24);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px}
.splash .room-icon{font-size:5rem;margin-bottom:20px}
.splash p{color:rgba(255,255,255,0.6);max-width:450px;margin-bottom:28px;line-height:1.7}
.splash .start-btn{padding:16px 48px;background:linear-gradient(135deg,#ef4444,#dc2626);border:none;border-radius:14px;color:#fff;font-size:1.1rem;font-weight:800;cursor:pointer;font-family:inherit;transition:all 0.3s;box-shadow:0 4px 30px rgba(239,68,68,0.4)}
.splash .start-btn:hover{transform:translateY(-3px);box-shadow:0 8px 40px rgba(239,68,68,0.6)}
.splash .controls{margin-top:24px;font-size:0.8rem;color:rgba(255,255,255,0.3);line-height:1.8}
.splash .controls kbd{background:rgba(255,255,255,0.1);padding:2px 8px;border-radius:4px;font-family:'Courier New',monospace}
.back-link{position:fixed;top:12px;right:340px;z-index:20;color:rgba(255,255,255,0.5);text-decoration:none;font-size:0.85rem}
.back-link:hover{color:#fff}
.hidden{display:none!important}
@media(max-width:768px){.chat-panel{width:100%;height:40%;top:auto;border-left:none;border-top:1px solid rgba(239,68,68,0.2)}.crosshair{left:50%;top:30%}.back-link{right:12px;top:auto;bottom:calc(40% + 12px)}}
</style>
</head>
<body>
<div class="splash" id="splash">
  <div class="room-icon">üèãÔ∏è</div>
  <h1>The Gym</h1>
  <p>Iron paradise. Walk around the weight room, check out the equipment, and chat with other gym-goers. No judgement zone.</p>
  <button class="start-btn" onclick="enterRoom()">Enter Gym</button>
  <div class="controls"><kbd>W</kbd><kbd>S</kbd> or <kbd>‚Üë</kbd><kbd>‚Üì</kbd> Walk &nbsp;|&nbsp; <kbd>A</kbd><kbd>D</kbd> or <kbd>‚Üê</kbd><kbd>‚Üí</kbd> Turn &nbsp;|&nbsp; <kbd>Shift</kbd>+Turn = Strafe &nbsp;|&nbsp; <kbd>Mouse</kbd> Look &nbsp;|&nbsp; <kbd>T</kbd> Chat</div>
</div>
<a href="../games/index.html" class="back-link hidden" id="backLink">‚Üê Back to Hub</a>
<div class="hud-top hidden" id="hud"><div class="hud-pill"><span class="emoji">üèãÔ∏è</span> The Gym</div></div>
<div class="crosshair hidden" id="crosshair"></div>
<div class="chat-panel hidden" id="chatPanel">
  <div class="chat-header"><h3>üí¨ Gym Chat</h3><span class="room-count" id="userCount">5 online</span></div>
  <div class="chat-msgs" id="chatMsgs"></div>
  <div class="chat-input-wrap"><input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." maxlength="200" autocomplete="off"><button class="chat-send" onclick="sendChat()">Send</button></div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
var scene,camera,renderer,clock;
var keys={},euler=new THREE.Euler(0,0,0,'YXZ'),isPointerLocked=false,gameStarted=false;
var npcs=[],chatHistory=[];

var NPC_DATA=[
  {name:'Marcus',color:'#ef4444',msgs:['lets gooo üí™','one more set','anyone need a spot?','form check please','no pain no gain']},
  {name:'Tasha',color:'#f97316',msgs:['leg day today','that bench is free','I hit a PR yesterday!','stay hydrated','crushing it!']},
  {name:'Dev',color:'#22c55e',msgs:['whats your routine?','this gym is sick','just started my workout','need more protein','anyone doing cardio?']},
  {name:'Sam',color:'#06b6d4',msgs:['chest and tris today','the mirrors are great for form','new to this gym','rest day tomorrow','good session everyone']}
];

function addSystemMsg(t){chatHistory.push({type:'system',text:t});renderChat()}
function addNpcMsg(n,c,t){chatHistory.push({type:'npc',name:n,color:c,text:t});renderChat()}
function addPlayerMsg(t){chatHistory.push({type:'player',name:'You',color:'#ef4444',text:t});renderChat()}
function renderChat(){var el=document.getElementById('chatMsgs'),html='';chatHistory.slice(-50).forEach(function(m){if(m.type==='system')html+='<div class="chat-msg system">'+m.text+'</div>';else html+='<div class="chat-msg"><div class="name" style="color:'+m.color+'">'+m.name+'</div>'+m.text+'</div>';});el.innerHTML=html;el.scrollTop=el.scrollHeight}
function sendChat(){var input=document.getElementById('chatInput'),text=input.value.trim();if(!text)return;addPlayerMsg(text);input.value='';setTimeout(function(){if(Math.random()>0.3){var npc=NPC_DATA[Math.floor(Math.random()*NPC_DATA.length)];var r=['üí™','nice!','lets go!','respect','yep','agreed','haha','good stuff'];addNpcMsg(npc.name,npc.color,r[Math.floor(Math.random()*r.length)])}},1500+Math.random()*3000)}

function init(){
  scene=new THREE.Scene();scene.background=new THREE.Color(0x080810);
  camera=new THREE.PerspectiveCamera(70,(window.innerWidth-320)/window.innerHeight,0.1,100);
  camera.position.set(0,1.6,5);
  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth-320,window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  renderer.shadowMap.enabled=true;
  document.body.insertBefore(renderer.domElement,document.body.firstChild);
  clock=new THREE.Clock();

  // Lights ‚Äî harsh gym fluorescent + accent
  scene.add(new THREE.AmbientLight(0x222230,0.5));
  // Overhead strips
  for(var i=-2;i<=2;i++){var fl=new THREE.PointLight(0xffeedd,0.5,10);fl.position.set(i*3,3.5,0);scene.add(fl)}
  // Red accent
  var accent=new THREE.PointLight(0xef4444,0.4,12);accent.position.set(0,2,-6);scene.add(accent);

  buildGym();createNPCs();

  window.addEventListener('resize',function(){var w=window.innerWidth>768?window.innerWidth-320:window.innerWidth;var h=window.innerWidth>768?window.innerHeight:window.innerHeight*0.6;camera.aspect=w/h;camera.updateProjectionMatrix();renderer.setSize(w,h)});
  document.addEventListener('keydown',function(e){keys[e.code]=true;if(e.code==='KeyT'&&gameStarted){e.preventDefault();document.exitPointerLock();document.getElementById('chatInput').focus()}if(e.code==='Enter'&&document.activeElement===document.getElementById('chatInput'))sendChat()});
  document.addEventListener('keyup',function(e){keys[e.code]=false});
  document.addEventListener('mousemove',function(e){if(!isPointerLocked)return;var mx=Math.max(-50,Math.min(50,e.movementX));var my=Math.max(-50,Math.min(50,e.movementY));euler.y-=mx*0.002;euler.x-=my*0.002;euler.x=Math.max(-0.9,Math.min(0.9,euler.x));camera.quaternion.setFromEuler(euler)});
  renderer.domElement.addEventListener('click',function(){if(gameStarted)renderer.domElement.requestPointerLock()});
  document.addEventListener('pointerlockchange',function(){isPointerLocked=(document.pointerLockElement===renderer.domElement)});
  renderer.render(scene,camera);
}

function addBox(w,h,d,color,x,y,z,emissive){
  var mat=new THREE.MeshStandardMaterial({color:color,roughness:0.7,metalness:0.2});
  if(emissive){mat.emissive=new THREE.Color(color);mat.emissiveIntensity=0.5}
  var mesh=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),mat);
  mesh.position.set(x,y,z);mesh.castShadow=true;mesh.receiveShadow=true;
  scene.add(mesh);return mesh;
}

function addCylinder(rt,rb,h,color,x,y,z){
  var mat=new THREE.MeshStandardMaterial({color:color,roughness:0.5,metalness:0.5});
  var mesh=new THREE.Mesh(new THREE.CylinderGeometry(rt,rb,h,16),mat);
  mesh.position.set(x,y,z);mesh.castShadow=true;scene.add(mesh);return mesh;
}

function buildGym(){
  var room=16,rw=10,h=4;
  // Floor ‚Äî rubber mat dark gray
  var floor=new THREE.Mesh(new THREE.PlaneGeometry(room,rw),new THREE.MeshStandardMaterial({color:0x1a1a22,roughness:0.95}));
  floor.rotation.x=-Math.PI/2;floor.receiveShadow=true;scene.add(floor);
  // Ceiling
  var c=new THREE.Mesh(new THREE.PlaneGeometry(room,rw),new THREE.MeshStandardMaterial({color:0x0e0e15,roughness:0.95}));
  c.rotation.x=Math.PI/2;c.position.y=h;scene.add(c);
  // Walls
  var wm=new THREE.MeshStandardMaterial({color:0x151520,roughness:0.9});
  var addWall=function(w2,ht,x,y,z,ry){var w=new THREE.Mesh(new THREE.PlaneGeometry(w2,ht),wm);w.position.set(x,y,z);w.rotation.y=ry||0;w.receiveShadow=true;scene.add(w)};
  addWall(room,h,0,h/2,-rw/2,0);addWall(room,h,0,h/2,rw/2,Math.PI);addWall(rw,h,-room/2,h/2,0,Math.PI/2);addWall(rw,h,room/2,h/2,0,-Math.PI/2);

  // Mirror wall ‚Äî back
  var mirror=new THREE.Mesh(new THREE.PlaneGeometry(14,3),new THREE.MeshStandardMaterial({color:0x334466,roughness:0.1,metalness:0.8}));
  mirror.position.set(0,2,-4.95);scene.add(mirror);

  // Bench press station (center-left)
  addBox(1.4,0.45,0.4,0x1a1a2a,-3,0.22,0);// bench pad
  addBox(0.08,0.45,0.08,0x444450,-3.65,0.22,0);// leg
  addBox(0.08,0.45,0.08,0x444450,-2.35,0.22,0);// leg
  // Uprights
  addCylinder(0.04,0.04,1.5,0x555560,-3.6,0.75,0);
  addCylinder(0.04,0.04,1.5,0x555560,-2.4,0.75,0);
  // Bar
  addCylinder(0.025,0.025,1.8,0x888890,-3,1.45,0);
  // Plates
  addCylinder(0.18,0.18,0.05,0x222230,-3.8,1.45,0);
  addCylinder(0.18,0.18,0.05,0x222230,-2.2,1.45,0);
  addCylinder(0.22,0.22,0.05,0x181825,-3.88,1.45,0);
  addCylinder(0.22,0.22,0.05,0x181825,-2.12,1.45,0);

  // Squat rack (center-right)
  addCylinder(0.04,0.04,2.2,0x555560,3,1.1,-2);
  addCylinder(0.04,0.04,2.2,0x555560,4.2,1.1,-2);
  addBox(1.3,0.06,0.06,0x555560,3.6,2.2,-2);// top crossbar
  // Bar on rack
  addCylinder(0.025,0.025,1.8,0x888890,3.6,1.5,-2);
  addCylinder(0.2,0.2,0.05,0x222230,2.8,1.5,-2);
  addCylinder(0.2,0.2,0.05,0x222230,4.4,1.5,-2);
  // Safety bars
  addBox(1.4,0.04,0.04,0x444450,3.6,0.8,-2);

  // Dumbbell rack ‚Äî left wall
  addBox(0.5,1,3,0x1a1a25,-7,0.5,0);// rack frame
  for(var row=0;row<3;row++){
    for(var col=0;col<4;col++){
      // Dumbbells as small cylinders
      addCylinder(0.06,0.06,0.3,0x333340,-6.7,0.3+row*0.35,-0.9+col*0.6);
      // Plates on ends
      addCylinder(0.1,0.1,0.04,0x222230,-6.7,0.3+row*0.35,-1.08+col*0.6);
      addCylinder(0.1,0.1,0.04,0x222230,-6.7,0.3+row*0.35,-0.72+col*0.6);
    }
  }

  // Treadmill ‚Äî right side
  addBox(0.8,0.15,2,0x1a1a22,6,0.08,2);// base
  addBox(0.65,0.04,1.7,0x111118,6,0.17,2);// belt
  addCylinder(0.03,0.03,1.2,0x555560,6.3,0.85,1.1);// upright
  addCylinder(0.03,0.03,1.2,0x555560,5.7,0.85,1.1);// upright
  addBox(0.7,0.3,0.08,0x1a1a2a,6,1.45,1.1);// console
  var treadScreen=new THREE.Mesh(new THREE.PlaneGeometry(0.5,0.2),new THREE.MeshStandardMaterial({color:0x004422,emissive:0x00ff44,emissiveIntensity:0.1}));
  treadScreen.position.set(6,1.45,1.05);scene.add(treadScreen);

  // Punching bag ‚Äî back right
  addCylinder(0.03,0.03,0.8,0x555560,5,3.6,-3);// chain
  addCylinder(0.25,0.2,1,0x8b2020,5,2.7,-3);// bag

  // Kettlebells on floor
  for(var k=0;k<3;k++){
    var kb=new THREE.Mesh(new THREE.SphereGeometry(0.12,8,8),new THREE.MeshStandardMaterial({color:0x222230,roughness:0.5,metalness:0.6}));
    kb.position.set(-1+k*0.5,0.12,3.5);scene.add(kb);
  }

  // Exercise mats
  addBox(2,0.03,1,0x2a1040,0,0.015,3);
  addBox(2,0.03,1,0x102a40,2.5,0.015,3);

  // Water cooler
  addCylinder(0.2,0.2,0.8,0x3388cc,7,0.4,-3);
  addBox(0.5,0.8,0.3,0x2a2a35,7,0.4,-3.3);

  // Motivational text on wall (simple box)
  addBox(3,0.6,0.02,0xef4444,0,3,-4.94,true);
}

function createNPCs(){
  NPC_DATA.forEach(function(data,i){
    var color=new THREE.Color(data.color);
    var body=new THREE.Mesh(new THREE.CylinderGeometry(0.22,0.24,1.1,8),new THREE.MeshStandardMaterial({color:color}));
    var head=new THREE.Mesh(new THREE.SphereGeometry(0.18,8,8),new THREE.MeshStandardMaterial({color:0xdbb896}));
    head.position.y=0.75;body.add(head);
    var cv=document.createElement('canvas');cv.width=128;cv.height=32;var cx=cv.getContext('2d');cx.font='bold 18px sans-serif';cx.fillStyle=data.color;cx.textAlign='center';cx.fillText(data.name,64,22);
    var sp=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(cv),transparent:true}));sp.position.y=1.1;sp.scale.set(1.2,0.3,1);body.add(sp);
    var pos=[new THREE.Vector3(-3,0.55,2),new THREE.Vector3(2,0.55,1),new THREE.Vector3(5,0.55,-1),new THREE.Vector3(-1,0.55,-2)];
    body.position.copy(pos[i]);scene.add(body);
    npcs.push({mesh:body,data:data,target:pos[i].clone(),timer:Math.random()*5,chatTimer:5+Math.random()*12,baseY:0.55});
  });
}

function enterRoom(){
  gameStarted=true;
  document.getElementById('splash').classList.add('hidden');
  ['hud','crosshair','chatPanel','backLink'].forEach(function(id){document.getElementById(id).classList.remove('hidden')});
  renderer.domElement.requestPointerLock();
  addSystemMsg('Welcome to the Gym üèãÔ∏è');
  addSystemMsg('Walk around the equipment. Press T to chat.');
  NPC_DATA.forEach(function(d){addSystemMsg(d.name+' is working out.')});
  animate();
}

function animate(){
  requestAnimationFrame(animate);
  var dt=Math.min(clock.getDelta(),0.05);
  if(isPointerLocked){
    var speed=3.5*dt;
    var fwd=new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);fwd.y=0;fwd.normalize();
    var rt=new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion);rt.y=0;rt.normalize();
    var mv=new THREE.Vector3();
    if(keys['KeyW']||keys['ArrowUp'])mv.add(fwd.clone().multiplyScalar(speed));
    if(keys['KeyS']||keys['ArrowDown'])mv.add(fwd.clone().multiplyScalar(-speed));
    var shifting=keys['ShiftLeft']||keys['ShiftRight'];
    if(keys['KeyA']||keys['ArrowLeft']){if(shifting)mv.add(rt.clone().multiplyScalar(-speed));else{euler.y+=2.0*dt;camera.quaternion.setFromEuler(euler);}}
    if(keys['KeyD']||keys['ArrowRight']){if(shifting)mv.add(rt.clone().multiplyScalar(speed));else{euler.y-=2.0*dt;camera.quaternion.setFromEuler(euler);}}
    camera.position.add(mv);
    // NPC collision
    npcs.forEach(function(npc){
      var dx=camera.position.x-npc.mesh.position.x;
      var dz=camera.position.z-npc.mesh.position.z;
      var d=Math.sqrt(dx*dx+dz*dz);
      if(d<1.0&&d>0.001){var push=1.0/d;camera.position.x=npc.mesh.position.x+dx*push;camera.position.z=npc.mesh.position.z+dz*push;}
    });
    camera.position.x=Math.max(-7,Math.min(7,camera.position.x));
    camera.position.z=Math.max(-4.2,Math.min(4.2,camera.position.z));
    camera.position.y=1.6;
  }
  npcs.forEach(function(npc){
    npc.timer-=dt;
    if(npc.timer<=0){npc.target.set(-5+Math.random()*10,npc.baseY,-3+Math.random()*6);npc.timer=3+Math.random()*6}
    var dir=npc.target.clone().sub(npc.mesh.position);
    if(dir.length()>0.2){dir.normalize().multiplyScalar(0.7*dt);dir.y=0;npc.mesh.position.add(dir);npc.mesh.rotation.y=Math.atan2(dir.x,dir.z)}
    npc.mesh.position.y=npc.baseY+Math.sin(Date.now()*0.004+npcs.indexOf(npc))*0.015;
    npc.chatTimer-=dt;
    if(npc.chatTimer<=0){addNpcMsg(npc.data.name,npc.data.color,npc.data.msgs[Math.floor(Math.random()*npc.data.msgs.length)]);npc.chatTimer=6+Math.random()*18}
  });
  renderer.render(scene,camera);
}
init();
</script>
</body>
</html>