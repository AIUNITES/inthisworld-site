<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Space Station Lounge ‚Äî InThisWorld</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#020208;color:#e0e0f0;font-family:'Segoe UI',system-ui,sans-serif;overflow:hidden}
canvas{display:block;position:fixed;top:0;left:0}
.chat-panel{position:fixed;right:0;top:0;bottom:0;width:320px;background:rgba(5,5,20,0.92);border-left:1px solid rgba(6,182,212,0.2);z-index:20;display:flex;flex-direction:column;backdrop-filter:blur(8px)}
.chat-header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:space-between}
.chat-header h3{font-size:1rem;color:#22d3ee}
.chat-header .room-count{font-size:0.75rem;color:rgba(255,255,255,0.4);background:rgba(6,182,212,0.15);padding:3px 10px;border-radius:10px}
.chat-msgs{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:8px;scrollbar-width:thin;scrollbar-color:rgba(6,182,212,0.3) transparent}
.chat-msg{padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.03);font-size:0.85rem;line-height:1.5;animation:msgIn 0.3s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.chat-msg .name{font-weight:700;font-size:0.8rem;margin-bottom:2px}
.chat-msg.system{background:rgba(6,182,212,0.08);color:#22d3ee;font-style:italic;font-size:0.8rem}
.chat-input-wrap{padding:12px;border-top:1px solid rgba(255,255,255,0.06);display:flex;gap:8px}
.chat-input{flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:10px 14px;color:#fff;font-family:inherit;font-size:0.9rem;outline:none}
.chat-input:focus{border-color:rgba(6,182,212,0.4)}
.chat-send{background:linear-gradient(135deg,#06b6d4,#0891b2);border:none;border-radius:10px;padding:10px 16px;color:#fff;font-weight:700;cursor:pointer;font-family:inherit;transition:all 0.2s}
.chat-send:hover{box-shadow:0 4px 15px rgba(6,182,212,0.4)}
.hud-top{position:fixed;top:12px;left:12px;z-index:15;display:flex;gap:10px;align-items:center}
.hud-pill{background:rgba(5,5,20,0.85);border:1px solid rgba(6,182,212,0.25);border-radius:20px;padding:8px 16px;font-size:0.85rem;font-weight:600;backdrop-filter:blur(6px)}
.hud-pill .emoji{margin-right:6px}
.crosshair{position:fixed;top:50%;left:calc(50% - 160px);transform:translate(-50%,-50%);width:8px;height:8px;border:1px solid rgba(6,182,212,0.4);border-radius:50%;z-index:12;pointer-events:none}
.splash{position:fixed;inset:0;z-index:200;background:radial-gradient(ellipse at 50% 40%,#0a1530,#020208);display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:20px}
.splash h1{font-size:clamp(2rem,5vw,3.5rem);background:linear-gradient(135deg,#06b6d4,#22d3ee,#67e8f9,#fff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px}
.splash .room-icon{font-size:5rem;margin-bottom:20px}
.splash p{color:rgba(255,255,255,0.6);max-width:480px;margin-bottom:28px;line-height:1.7}
.splash .start-btn{padding:16px 48px;background:linear-gradient(135deg,#06b6d4,#0891b2);border:none;border-radius:14px;color:#fff;font-size:1.1rem;font-weight:800;cursor:pointer;font-family:inherit;transition:all 0.3s;box-shadow:0 4px 30px rgba(6,182,212,0.4)}
.splash .start-btn:hover{transform:translateY(-3px);box-shadow:0 8px 40px rgba(6,182,212,0.6)}
.splash .controls{margin-top:24px;font-size:0.8rem;color:rgba(255,255,255,0.3);line-height:1.8}
.splash .controls kbd{background:rgba(255,255,255,0.1);padding:2px 8px;border-radius:4px;font-family:'Courier New',monospace}
.back-link{position:fixed;top:12px;right:340px;z-index:20;color:rgba(255,255,255,0.5);text-decoration:none;font-size:0.85rem}
.back-link:hover{color:#fff}
.hidden{display:none!important}
@media(max-width:768px){.chat-panel{width:100%;height:40%;top:auto;border-left:none;border-top:1px solid rgba(6,182,212,0.2)}.crosshair{left:50%;top:30%}.back-link{right:12px;top:auto;bottom:calc(40% + 12px)}}
</style>
</head>
<body>
<div class="splash" id="splash">
  <div class="room-icon">üõ∏</div>
  <h1>Space Station Lounge</h1>
  <p>A circular observation lounge orbiting high above the planet. Floor-to-ceiling windows reveal the stars, nebulae, and passing ships. The ultimate social club among the cosmos.</p>
  <button class="start-btn" onclick="enterRoom()">Board Station</button>
  <div class="controls"><kbd>W</kbd><kbd>S</kbd> Walk &nbsp;|&nbsp; <kbd>A</kbd><kbd>D</kbd> Turn &nbsp;|&nbsp; <kbd>Shift</kbd>+<kbd>A</kbd><kbd>D</kbd> Strafe &nbsp;|&nbsp; <kbd>Mouse</kbd> Look &nbsp;|&nbsp; <kbd>T</kbd> Chat</div>
</div>
<a href="../rooms/index.html" class="back-link hidden" id="backLink">‚Üê Back to Rooms</a>
<div class="hud-top hidden" id="hud"><div class="hud-pill"><span class="emoji">üõ∏</span> Station Lounge ‚Äî Orbit Alt: 420km</div></div>
<div class="crosshair hidden" id="crosshair"></div>
<div class="chat-panel hidden" id="chatPanel">
  <div class="chat-header"><h3>üì° Station Chat</h3><span class="room-count" id="userCount">6 online</span></div>
  <div class="chat-msgs" id="chatMsgs"></div>
  <div class="chat-input-wrap"><input type="text" class="chat-input" id="chatInput" placeholder="Transmit message..." maxlength="200" autocomplete="off"><button class="chat-send" onclick="sendChat()">Send</button></div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// ============================================================
// SPACE STATION LOUNGE ‚Äî Circular 3D Chat Room in Orbit
// ============================================================
var scene,camera,renderer,clock;
var keys={},euler=new THREE.Euler(0,0,0,'YXZ'),isPointerLocked=false,gameStarted=false;
var npcs=[],chatHistory=[];
var stationRotation=0;
var starField,nebulaMeshes=[],shipMeshes=[];

var NPC_DATA=[
  {name:'Captain Voss',color:'#22d3ee',msgs:['Welcome aboard, traveler','We orbit at 420 klicks ‚Äî beautiful view','The nebula is putting on a show tonight','All systems nominal','Anyone seen the supply shuttle?']},
  {name:'Dr. Lumen',color:'#a78bfa',msgs:['The star density here is remarkable','I\'m studying the pulsar on the port side','Science never sleeps','Fascinating readings today','Have you looked out window 3?']},
  {name:'Zara',color:'#f472b6',msgs:['This lounge has the best view in the galaxy','Who wants space coffee?','I could stare out these windows forever','Just docked from Solara Prime','The music in here is so chill']},
  {name:'Kev',color:'#4ade80',msgs:['Just got back from a supply run','Anyone play Arena FPS? I got top score','The artificial gravity feels off today','Check out that freighter passing by','This station is home']},
  {name:'Nova',color:'#fbbf24',msgs:['‚ú® stars are beautiful tonight','First time on this station!','Is that a comet??','Earth looks so small from up here','Love this place']}
];

function addSystemMsg(t){chatHistory.push({type:'system',text:t});renderChat()}
function addNpcMsg(n,c,t){chatHistory.push({type:'npc',name:n,color:c,text:t});renderChat()}
function addPlayerMsg(t){chatHistory.push({type:'player',name:'You',color:'#06b6d4',text:t});renderChat()}
function renderChat(){var el=document.getElementById('chatMsgs'),html='';chatHistory.slice(-50).forEach(function(m){if(m.type==='system')html+='<div class="chat-msg system">'+m.text+'</div>';else html+='<div class="chat-msg"><div class="name" style="color:'+m.color+'">'+m.name+'</div>'+m.text+'</div>';});el.innerHTML=html;el.scrollTop=el.scrollHeight}
function sendChat(){var input=document.getElementById('chatInput'),text=input.value.trim();if(!text)return;addPlayerMsg(text);input.value='';setTimeout(function(){if(Math.random()>0.3){var npc=NPC_DATA[Math.floor(Math.random()*NPC_DATA.length)];var r=['roger that','copy','haha','nice one','üöÄ','for real','agreed','welcome aboard','üëç','incredible'];addNpcMsg(npc.name,npc.color,r[Math.floor(Math.random()*r.length)])}},1200+Math.random()*3000)}

function init(){
  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x020208);

  camera=new THREE.PerspectiveCamera(75,(window.innerWidth-320)/window.innerHeight,0.1,2000);
  camera.position.set(0,1.6,0);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth-320,window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  renderer.shadowMap.enabled=true;
  document.body.insertBefore(renderer.domElement,document.body.firstChild);
  clock=new THREE.Clock();

  // === SPACE ENVIRONMENT (outside the station) ===
  // Dense starfield
  var starGeo=new THREE.BufferGeometry();
  var sv=[];
  for(var i=0;i<8000;i++){
    var r=300+Math.random()*700;
    var theta=Math.random()*Math.PI*2;
    var phi=Math.acos(2*Math.random()-1);
    sv.push(r*Math.sin(phi)*Math.cos(theta),r*Math.sin(phi)*Math.sin(theta),r*Math.cos(phi));
  }
  starGeo.setAttribute('position',new THREE.Float32BufferAttribute(sv,3));
  starField=new THREE.Points(starGeo,new THREE.PointsMaterial({color:0xffffff,size:0.8,transparent:true,opacity:0.8}));
  scene.add(starField);

  // Nebula clouds ‚Äî colorful transparent spheres at distance
  var nebulaColors=[0x6366f1,0xf472b6,0x06b6d4,0xa855f7,0x22c55e];
  for(var n=0;n<12;n++){
    var ng=new THREE.SphereGeometry(15+Math.random()*30,8,8);
    var nm=new THREE.MeshBasicMaterial({color:nebulaColors[n%nebulaColors.length],transparent:true,opacity:0.04+Math.random()*0.03,side:THREE.DoubleSide});
    var nMesh=new THREE.Mesh(ng,nm);
    var nd=200+Math.random()*300;
    var nt=Math.random()*Math.PI*2;
    var np=Math.random()*Math.PI;
    nMesh.position.set(nd*Math.sin(np)*Math.cos(nt),nd*Math.sin(np)*Math.sin(nt)-50,nd*Math.cos(np));
    scene.add(nMesh);
    nebulaMeshes.push(nMesh);
  }

  // Planet below (visible through windows)
  var planetGeo=new THREE.SphereGeometry(120,64,64);
  var planetMat=new THREE.MeshStandardMaterial({color:0x1e40af,emissive:0x0a1428,emissiveIntensity:0.3,roughness:0.8});
  var planet=new THREE.Mesh(planetGeo,planetMat);
  planet.position.set(0,-135,0);
  scene.add(planet);
  // Atmosphere
  var atmoGeo=new THREE.SphereGeometry(123,64,64);
  var atmoMat=new THREE.MeshBasicMaterial({color:0x3b82f6,transparent:true,opacity:0.08,side:THREE.BackSide});
  scene.add(new THREE.Mesh(atmoGeo,atmoMat).add(planet)&&planet.parent||planet);
  var atmo=new THREE.Mesh(atmoGeo,atmoMat);
  atmo.position.copy(planet.position);
  scene.add(atmo);

  // Passing ships (small distant objects)
  for(var s=0;s<4;s++){
    var sg=new THREE.BoxGeometry(1,0.3,2);
    var sm=new THREE.MeshBasicMaterial({color:0xcccccc,emissive:0x444444});
    var sMesh=new THREE.Mesh(sg,new THREE.MeshBasicMaterial({color:0x888899}));
    // Engine glow
    var eng=new THREE.Mesh(new THREE.SphereGeometry(0.2,4,4),new THREE.MeshBasicMaterial({color:0x06b6d4,transparent:true,opacity:0.8}));
    eng.position.z=1.2;sMesh.add(eng);
    sMesh.position.set(60+Math.random()*80,(Math.random()-0.5)*20,-40+s*25);
    sMesh.userData={speed:2+Math.random()*3,resetX:-100-Math.random()*50};
    scene.add(sMesh);
    shipMeshes.push(sMesh);
  }

  // === STATION INTERIOR ===
  // Lights
  scene.add(new THREE.AmbientLight(0x0a1020,0.5));
  // Overhead ring light (cyan)
  var ringLight=new THREE.PointLight(0x06b6d4,0.6,20);ringLight.position.set(0,2.8,0);scene.add(ringLight);
  // Accent lights around the ring
  for(var l=0;l<6;l++){
    var ang=l/6*Math.PI*2;
    var al=new THREE.PointLight(0x334466,0.3,8);
    al.position.set(Math.cos(ang)*6,2.5,Math.sin(ang)*6);
    scene.add(al);
  }
  // Warm spot for bar area
  var barLight=new THREE.PointLight(0xf59e0b,0.4,8);barLight.position.set(0,2,5);scene.add(barLight);

  buildStation();
  createNPCs();

  window.addEventListener('resize',function(){var w=window.innerWidth>768?window.innerWidth-320:window.innerWidth;var h=window.innerWidth>768?window.innerHeight:window.innerHeight*0.6;camera.aspect=w/h;camera.updateProjectionMatrix();renderer.setSize(w,h)});
  document.addEventListener('keydown',function(e){keys[e.code]=true;if(e.code==='KeyT'&&gameStarted){e.preventDefault();document.exitPointerLock();document.getElementById('chatInput').focus()}if(e.code==='Enter'&&document.activeElement===document.getElementById('chatInput'))sendChat()});
  document.addEventListener('keyup',function(e){keys[e.code]=false});
  document.addEventListener('mousemove',function(e){if(!isPointerLocked)return;var mx=Math.max(-50,Math.min(50,e.movementX));var my=Math.max(-50,Math.min(50,e.movementY));euler.y-=mx*0.002;euler.x-=my*0.002;euler.x=Math.max(-0.9,Math.min(0.9,euler.x));camera.quaternion.setFromEuler(euler)});
  renderer.domElement.addEventListener('click',function(){if(gameStarted)renderer.domElement.requestPointerLock()});
  document.addEventListener('pointerlockchange',function(){isPointerLocked=(document.pointerLockElement===renderer.domElement)});
  renderer.render(scene,camera);
}

function addBox(w,h,d,color,x,y,z,emissive){
  var mat=new THREE.MeshStandardMaterial({color:color,roughness:0.6,metalness:0.3});
  if(emissive){mat.emissive=new THREE.Color(color);mat.emissiveIntensity=0.4}
  var mesh=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),mat);
  mesh.position.set(x,y,z);mesh.castShadow=true;mesh.receiveShadow=true;
  scene.add(mesh);return mesh;
}

function buildStation(){
  var radius=8;
  var h=3.5;
  var segments=48;

  // === FLOOR ‚Äî dark metallic disc ===
  var floorGeo=new THREE.CircleGeometry(radius,segments);
  var floorMat=new THREE.MeshStandardMaterial({color:0x12151e,roughness:0.8,metalness:0.3});
  var floor=new THREE.Mesh(floorGeo,floorMat);
  floor.rotation.x=-Math.PI/2;floor.receiveShadow=true;
  scene.add(floor);

  // Floor detail ‚Äî concentric rings
  for(var fr=2;fr<=7;fr+=2.5){
    var ringGeo=new THREE.RingGeometry(fr-0.03,fr+0.03,segments);
    var ringMat=new THREE.MeshBasicMaterial({color:0x06b6d4,transparent:true,opacity:0.08,side:THREE.DoubleSide});
    var ring=new THREE.Mesh(ringGeo,ringMat);
    ring.rotation.x=-Math.PI/2;ring.position.y=0.01;
    scene.add(ring);
  }

  // === CEILING ‚Äî metallic with light ring ===
  var ceilGeo=new THREE.CircleGeometry(radius,segments);
  var ceilMat=new THREE.MeshStandardMaterial({color:0x0a0e16,roughness:0.9,metalness:0.2});
  var ceil=new THREE.Mesh(ceilGeo,ceilMat);
  ceil.rotation.x=Math.PI/2;ceil.position.y=h;
  scene.add(ceil);

  // Ceiling light ring (emissive)
  var ceilRingGeo=new THREE.TorusGeometry(3,0.08,8,segments);
  var ceilRingMat=new THREE.MeshBasicMaterial({color:0x06b6d4,transparent:true,opacity:0.5});
  var ceilRing=new THREE.Mesh(ceilRingGeo,ceilRingMat);
  ceilRing.rotation.x=Math.PI/2;ceilRing.position.y=h-0.05;
  scene.add(ceilRing);

  // === WALLS ‚Äî curved with windows ===
  // Wall is made of segments; some are solid, some are "windows" (transparent/glass)
  var wallSegs=24;
  var windowIndices=[0,1,2,4,5,6,8,9,10,12,13,14,16,17,18,20,21,22]; // window segments
  var pillarIndices=[3,7,11,15,19,23]; // solid pillars between window groups

  for(var ws=0;ws<wallSegs;ws++){
    var ang1=(ws/wallSegs)*Math.PI*2;
    var ang2=((ws+1)/wallSegs)*Math.PI*2;
    var midAng=(ang1+ang2)/2;

    var isWindow=windowIndices.indexOf(ws)!==-1;

    if(isWindow){
      // Glass panel ‚Äî very transparent, slight blue tint
      var shape=new THREE.Shape();
      var x1=Math.cos(ang1)*radius,z1=Math.sin(ang1)*radius;
      var x2=Math.cos(ang2)*radius,z2=Math.sin(ang2)*radius;
      // Simple plane oriented outward
      var glassMat=new THREE.MeshBasicMaterial({color:0x0a2040,transparent:true,opacity:0.12,side:THREE.DoubleSide});
      var glassGeo=new THREE.PlaneGeometry(2*radius*Math.sin(Math.PI/wallSegs),h-0.6);
      var glass=new THREE.Mesh(glassGeo,glassMat);
      glass.position.set(Math.cos(midAng)*radius,h/2+0.1,Math.sin(midAng)*radius);
      glass.rotation.y=-midAng+Math.PI/2;
      scene.add(glass);

      // Window frame ‚Äî top and bottom bars
      var frameW=2*radius*Math.sin(Math.PI/wallSegs)+0.1;
      var frameMat=new THREE.MeshStandardMaterial({color:0x1a2030,roughness:0.5,metalness:0.6});
      // Bottom frame
      var bf=new THREE.Mesh(new THREE.BoxGeometry(frameW,0.08,0.06),frameMat);
      bf.position.set(Math.cos(midAng)*radius,0.3,Math.sin(midAng)*radius);
      bf.rotation.y=-midAng+Math.PI/2;scene.add(bf);
      // Top frame
      var tf=new THREE.Mesh(new THREE.BoxGeometry(frameW,0.08,0.06),frameMat);
      tf.position.set(Math.cos(midAng)*radius,h-0.15,Math.sin(midAng)*radius);
      tf.rotation.y=-midAng+Math.PI/2;scene.add(tf);
    } else {
      // Solid pillar between window groups
      var pillarMat=new THREE.MeshStandardMaterial({color:0x151a28,roughness:0.5,metalness:0.5});
      var pw=2*radius*Math.sin(Math.PI/wallSegs)+0.05;
      var pillar=new THREE.Mesh(new THREE.BoxGeometry(pw+0.3,h,0.15),pillarMat);
      pillar.position.set(Math.cos(midAng)*radius,h/2,Math.sin(midAng)*radius);
      pillar.rotation.y=-midAng+Math.PI/2;
      scene.add(pillar);

      // Cyan accent strip on pillar
      var strip=new THREE.Mesh(new THREE.BoxGeometry(0.04,h-0.5,0.02),new THREE.MeshBasicMaterial({color:0x06b6d4,transparent:true,opacity:0.3}));
      strip.position.set(Math.cos(midAng)*(radius-0.05),h/2,Math.sin(midAng)*(radius-0.05));
      strip.rotation.y=-midAng+Math.PI/2;
      scene.add(strip);
    }
  }

  // === FURNITURE ===

  // Central holographic table
  var tableGeo=new THREE.CylinderGeometry(1.2,1.2,0.08,32);
  var tableMat=new THREE.MeshStandardMaterial({color:0x0a1428,roughness:0.3,metalness:0.7});
  var table=new THREE.Mesh(tableGeo,tableMat);
  table.position.set(0,0.7,0);scene.add(table);
  // Table pedestal
  var ped=new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.3,0.7,16),new THREE.MeshStandardMaterial({color:0x151a28,roughness:0.4,metalness:0.6}));
  ped.position.set(0,0.35,0);scene.add(ped);
  // Hologram above table
  var holoGeo=new THREE.SphereGeometry(0.4,16,16);
  var holoMat=new THREE.MeshBasicMaterial({color:0x06b6d4,transparent:true,opacity:0.15,wireframe:true});
  var holo=new THREE.Mesh(holoGeo,holoMat);
  holo.position.set(0,1.3,0);scene.add(holo);
  // Holo planet
  var holoPlanet=new THREE.Mesh(new THREE.SphereGeometry(0.25,12,12),new THREE.MeshBasicMaterial({color:0x22d3ee,transparent:true,opacity:0.2}));
  holoPlanet.position.set(0,1.3,0);scene.add(holoPlanet);

  // Curved seating around center (4 bench arcs)
  for(var b=0;b<4;b++){
    var ba=b/4*Math.PI*2+Math.PI/8;
    var bx=Math.cos(ba)*2.8,bz=Math.sin(ba)*2.8;
    // Seat
    addBox(1.8,0.4,0.7,0x1a1530,bx,0.2,bz);
    // Seat back
    var backMesh=addBox(1.8,0.5,0.08,0x151228,bx+Math.cos(ba)*0.35,0.55,bz+Math.sin(ba)*0.35);
    backMesh.rotation.y=-ba;
    // Actually rotate seat too
    scene.children[scene.children.length-2].rotation.y=-ba;// approximate
  }

  // Bar counter ‚Äî near +Z wall
  var barAng=0;
  addBox(3,1,0.6,0x151a28,Math.cos(barAng)*5.5,0.5,Math.sin(barAng)*5.5);
  // Bar stools (3)
  for(var bs=0;bs<3;bs++){
    var bsAng=barAng+(bs-1)*0.15;
    addBox(0.35,0.06,0.35,0x1a1a2a,Math.cos(bsAng)*4.3,0.6,Math.sin(bsAng)*4.3);
    // Stool leg
    var stoolLeg=new THREE.Mesh(new THREE.CylinderGeometry(0.04,0.06,0.6,8),new THREE.MeshStandardMaterial({color:0x333340,metalness:0.5}));
    stoolLeg.position.set(Math.cos(bsAng)*4.3,0.3,Math.sin(bsAng)*4.3);
    scene.add(stoolLeg);
  }

  // Display screens on pillars (emissive panels)
  pillarIndices.forEach(function(pi,idx){
    if(idx%2===0){
      var pa=(pi/wallSegs)*Math.PI*2+(Math.PI/wallSegs);
      var screenMat=new THREE.MeshBasicMaterial({color:[0x06b6d4,0xa855f7,0x22c55e][idx%3],transparent:true,opacity:0.12});
      var scr=new THREE.Mesh(new THREE.PlaneGeometry(0.8,0.5),screenMat);
      scr.position.set(Math.cos(pa)*(radius-0.2),2,Math.sin(pa)*(radius-0.2));
      scr.rotation.y=-pa+Math.PI/2+Math.PI;
      scene.add(scr);
    }
  });

  // Planter pods (2)
  var planterAngs=[Math.PI*0.6,Math.PI*1.4];
  planterAngs.forEach(function(pa){
    var px=Math.cos(pa)*5,pz=Math.sin(pa)*5;
    var pot=new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.25,0.4,8),new THREE.MeshStandardMaterial({color:0x1a2030,roughness:0.7}));
    pot.position.set(px,0.2,pz);scene.add(pot);
    var foliage=new THREE.Mesh(new THREE.SphereGeometry(0.35,8,8),new THREE.MeshStandardMaterial({color:0x22c55e,emissive:0x0a2010,emissiveIntensity:0.2}));
    foliage.position.set(px,0.6,pz);scene.add(foliage);
  });
}

function createNPCs(){
  NPC_DATA.forEach(function(data,i){
    var color=new THREE.Color(data.color);
    var body=new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.22,1,8),new THREE.MeshStandardMaterial({color:color}));
    var head=new THREE.Mesh(new THREE.SphereGeometry(0.18,8,8),new THREE.MeshStandardMaterial({color:0xdbb896}));
    head.position.y=0.7;body.add(head);
    // Visor/helmet accent
    var visor=new THREE.Mesh(new THREE.BoxGeometry(0.28,0.08,0.1),new THREE.MeshBasicMaterial({color:data.color,transparent:true,opacity:0.6}));
    visor.position.y=0.72;visor.position.z=0.1;body.add(visor);

    var cv=document.createElement('canvas');cv.width=128;cv.height=32;var cx=cv.getContext('2d');cx.font='bold 16px sans-serif';cx.fillStyle=data.color;cx.textAlign='center';cx.fillText(data.name,64,22);
    var sp=new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(cv),transparent:true}));sp.position.y=1.05;sp.scale.set(1.4,0.35,1);body.add(sp);

    var ang=i/NPC_DATA.length*Math.PI*2;
    var pos=new THREE.Vector3(Math.cos(ang)*3,0.5,Math.sin(ang)*3);
    body.position.copy(pos);scene.add(body);
    npcs.push({mesh:body,data:data,target:pos.clone(),timer:Math.random()*5,chatTimer:4+Math.random()*12,baseY:0.5});
  });
}

function enterRoom(){
  gameStarted=true;
  document.getElementById('splash').classList.add('hidden');
  ['hud','crosshair','chatPanel','backLink'].forEach(function(id){document.getElementById(id).classList.remove('hidden')});
  renderer.domElement.requestPointerLock();
  addSystemMsg('üì° Welcome to Space Station Lounge');
  addSystemMsg('Orbital altitude: 420km. Enjoy the view.');
  NPC_DATA.forEach(function(d){addSystemMsg(d.name+' is aboard.')});
  animate();
}

function animate(){
  requestAnimationFrame(animate);
  var dt=Math.min(clock.getDelta(),0.05);
  var time=Date.now()*0.001;

  // Movement
  if(isPointerLocked){
    var speed=2.8*dt;
    var fwd=new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);fwd.y=0;fwd.normalize();
    var rt=new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion);rt.y=0;rt.normalize();
    var mv=new THREE.Vector3();
    if(keys['KeyW'])mv.add(fwd.clone().multiplyScalar(speed));
    if(keys['KeyS'])mv.add(fwd.clone().multiplyScalar(-speed));
    var shifting=keys['ShiftLeft']||keys['ShiftRight'];
    if(keys['KeyA']){if(shifting)mv.add(rt.clone().multiplyScalar(-speed));else{euler.y+=2.0*dt;camera.quaternion.setFromEuler(euler);}}
    if(keys['KeyD']){if(shifting)mv.add(rt.clone().multiplyScalar(speed));else{euler.y-=2.0*dt;camera.quaternion.setFromEuler(euler);}}
    camera.position.add(mv);
    // NPC collision ‚Äî push camera away from NPCs
    npcs.forEach(function(npc){
      var dx=camera.position.x-npc.mesh.position.x;
      var dz=camera.position.z-npc.mesh.position.z;
      var d=Math.sqrt(dx*dx+dz*dz);
      if(d<1.0&&d>0.001){var push=1.0/d;camera.position.x=npc.mesh.position.x+dx*push;camera.position.z=npc.mesh.position.z+dz*push;}
    });
    // Circular room bounds
    var dist=Math.sqrt(camera.position.x*camera.position.x+camera.position.z*camera.position.z);
    if(dist>7){
      camera.position.x*=7/dist;
      camera.position.z*=7/dist;
    }
    camera.position.y=1.6;
  }

  // Slow star rotation for parallax
  starField.rotation.y+=dt*0.003;
  starField.rotation.x+=dt*0.001;

  // Nebula pulse
  nebulaMeshes.forEach(function(nm,i){
    nm.material.opacity=0.03+Math.sin(time*0.3+i)*0.015;
  });

  // Hologram rotation
  scene.children.forEach(function(c){
    if(c.material&&c.material.wireframe){
      c.rotation.y+=dt*0.5;
      c.rotation.x+=dt*0.2;
    }
  });

  // Passing ships
  shipMeshes.forEach(function(sm){
    sm.position.x-=sm.userData.speed*dt;
    if(sm.position.x<sm.userData.resetX){
      sm.position.x=80+Math.random()*40;
      sm.position.y=(Math.random()-0.5)*15;
      sm.position.z=-30+Math.random()*60;
    }
  });

  // NPC movement
  npcs.forEach(function(npc){
    npc.timer-=dt;
    if(npc.timer<=0){
      var a=Math.random()*Math.PI*2;
      var r=1+Math.random()*4.5;
      npc.target.set(Math.cos(a)*r,npc.baseY,Math.sin(a)*r);
      npc.timer=3+Math.random()*6;
    }
    var dir=npc.target.clone().sub(npc.mesh.position);
    if(dir.length()>0.2){dir.normalize().multiplyScalar(0.5*dt);dir.y=0;npc.mesh.position.add(dir);npc.mesh.rotation.y=Math.atan2(dir.x,dir.z)}
    npc.mesh.position.y=npc.baseY+Math.sin(time*2+npcs.indexOf(npc))*0.01;
    npc.chatTimer-=dt;
    if(npc.chatTimer<=0){addNpcMsg(npc.data.name,npc.data.color,npc.data.msgs[Math.floor(Math.random()*npc.data.msgs.length)]);npc.chatTimer=7+Math.random()*18}
  });

  renderer.render(scene,camera);
}
init();
</script>
</body>
</html>