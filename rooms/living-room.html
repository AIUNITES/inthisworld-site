<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Living Room ‚Äî InThisWorld</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a0f;color:#e0e0f0;font-family:'Segoe UI',system-ui,sans-serif;overflow:hidden}
canvas{display:block;position:fixed;top:0;left:0}

/* Chat Panel */
.chat-panel{position:fixed;right:0;top:0;bottom:0;width:320px;background:rgba(10,10,25,0.92);border-left:1px solid rgba(139,92,246,0.2);z-index:20;display:flex;flex-direction:column;backdrop-filter:blur(8px)}
.chat-header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:space-between}
.chat-header h3{font-size:1rem;color:#a78bfa}
.chat-header .room-count{font-size:0.75rem;color:rgba(255,255,255,0.4);background:rgba(139,92,246,0.15);padding:3px 10px;border-radius:10px}
.chat-msgs{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:8px;scrollbar-width:thin;scrollbar-color:rgba(139,92,246,0.3) transparent}
.chat-msg{padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.03);font-size:0.85rem;line-height:1.5;animation:msgIn 0.3s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.chat-msg .name{font-weight:700;font-size:0.8rem;margin-bottom:2px}
.chat-msg.system{background:rgba(139,92,246,0.08);color:#a78bfa;font-style:italic;font-size:0.8rem}
.chat-input-wrap{padding:12px;border-top:1px solid rgba(255,255,255,0.06);display:flex;gap:8px}
.chat-input{flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:10px 14px;color:#fff;font-family:inherit;font-size:0.9rem;outline:none}
.chat-input:focus{border-color:rgba(139,92,246,0.4)}
.chat-send{background:linear-gradient(135deg,#8b5cf6,#a855f7);border:none;border-radius:10px;padding:10px 16px;color:#fff;font-weight:700;cursor:pointer;font-family:inherit;transition:all 0.2s}
.chat-send:hover{box-shadow:0 4px 15px rgba(139,92,246,0.4)}

/* HUD */
.hud-top{position:fixed;top:12px;left:12px;z-index:15;display:flex;gap:10px;align-items:center}
.hud-pill{background:rgba(10,10,30,0.85);border:1px solid rgba(139,92,246,0.25);border-radius:20px;padding:8px 16px;font-size:0.85rem;font-weight:600;backdrop-filter:blur(6px)}
.hud-pill .emoji{margin-right:6px}

.crosshair{position:fixed;top:50%;left:calc(50% - 160px);transform:translate(-50%,-50%);width:6px;height:6px;border-radius:50%;background:rgba(255,255,255,0.3);z-index:12;pointer-events:none}

/* Splash */
.splash{position:fixed;inset:0;z-index:200;background:radial-gradient(ellipse at 50% 40%,#1a1040,#050510);display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:20px}
.splash h1{font-size:clamp(2rem,5vw,3.5rem);background:linear-gradient(135deg,#f59e0b,#fbbf24,#fde68a);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px}
.splash .room-icon{font-size:5rem;margin-bottom:20px}
.splash p{color:rgba(255,255,255,0.6);max-width:450px;margin-bottom:28px;line-height:1.7}
.splash .start-btn{padding:16px 48px;background:linear-gradient(135deg,#f59e0b,#d97706);border:none;border-radius:14px;color:#fff;font-size:1.1rem;font-weight:800;cursor:pointer;font-family:inherit;transition:all 0.3s;box-shadow:0 4px 30px rgba(245,158,11,0.4)}
.splash .start-btn:hover{transform:translateY(-3px);box-shadow:0 8px 40px rgba(245,158,11,0.6)}
.splash .controls{margin-top:24px;font-size:0.8rem;color:rgba(255,255,255,0.3);line-height:1.8}
.splash .controls kbd{background:rgba(255,255,255,0.1);padding:2px 8px;border-radius:4px;font-family:'Courier New',monospace}
.back-link{position:fixed;top:12px;right:340px;z-index:20;color:rgba(255,255,255,0.5);text-decoration:none;font-size:0.85rem}
.back-link:hover{color:#fff}
.hidden{display:none!important}

@media(max-width:768px){
  .chat-panel{width:100%;height:40%;top:auto;border-left:none;border-top:1px solid rgba(139,92,246,0.2)}
  .crosshair{left:50%;top:30%}
  .back-link{right:12px;top:auto;bottom:calc(40% + 12px)}
}
</style>
</head>
<body>

<div class="splash" id="splash">
  <div class="room-icon">üõãÔ∏è</div>
  <h1>The Living Room</h1>
  <p>A cozy space to hang out and chat. Walk around the room, check out the fireplace, and meet other visitors. Type in chat to talk.</p>
  <button class="start-btn" onclick="enterRoom()">Enter Room</button>
  <div class="controls">
    <kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd> Walk &nbsp;|&nbsp;
    <kbd>Mouse</kbd> Look &nbsp;|&nbsp;
    <kbd>Enter</kbd> Chat &nbsp;|&nbsp;
    <kbd>T</kbd> Focus Chat
  </div>
</div>

<a href="../games/index.html" class="back-link hidden" id="backLink">‚Üê Back to Hub</a>

<div class="hud-top hidden" id="hud">
  <div class="hud-pill"><span class="emoji">üõãÔ∏è</span> Living Room</div>
</div>
<div class="crosshair hidden" id="crosshair"></div>

<div class="chat-panel hidden" id="chatPanel">
  <div class="chat-header">
    <h3>üí¨ Room Chat</h3>
    <span class="room-count" id="userCount">4 online</span>
  </div>
  <div class="chat-msgs" id="chatMsgs"></div>
  <div class="chat-input-wrap">
    <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." maxlength="200" autocomplete="off">
    <button class="chat-send" onclick="sendChat()">Send</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// ============================================================
// THE LIVING ROOM ‚Äî 3D Chat Room
// ============================================================

var scene, camera, renderer, clock;
var keys = {};
var euler = new THREE.Euler(0, 0, 0, 'YXZ');
var isPointerLocked = false;
var gameStarted = false;
var npcs = [];
var chatHistory = [];

// NPC names and messages
var NPC_DATA = [
  { name: 'Alex', color: '#06b6d4', msgs: [
    'Has anyone tried the new games section?',
    'I love the fireplace ambiance',
    'This room is so cozy',
    'Hey everyone!',
    'What are you all up to?'
  ]},
  { name: 'Morgan', color: '#22c55e', msgs: [
    'Just got here, nice room!',
    'The lighting is great',
    'Anyone want to play Space Trader later?',
    'I scored 5000 in Arena FPS yesterday',
    'lol nice'
  ]},
  { name: 'Riley', color: '#f59e0b', msgs: [
    'Hello! üëã',
    'Check out the bookshelf',
    'I wonder what the other rooms look like',
    'brb grabbing coffee',
    'This is really cool'
  ]}
];

function addSystemMsg(text) {
  chatHistory.push({ type: 'system', text: text });
  renderChat();
}

function addNpcMsg(name, color, text) {
  chatHistory.push({ type: 'npc', name: name, color: color, text: text });
  renderChat();
}

function addPlayerMsg(text) {
  chatHistory.push({ type: 'player', name: 'You', color: '#8b5cf6', text: text });
  renderChat();
}

function renderChat() {
  var el = document.getElementById('chatMsgs');
  var html = '';
  var recent = chatHistory.slice(-50);
  recent.forEach(function(m) {
    if (m.type === 'system') {
      html += '<div class="chat-msg system">' + m.text + '</div>';
    } else {
      html += '<div class="chat-msg"><div class="name" style="color:' + m.color + '">' + m.name + '</div>' + m.text + '</div>';
    }
  });
  el.innerHTML = html;
  el.scrollTop = el.scrollHeight;
}

function sendChat() {
  var input = document.getElementById('chatInput');
  var text = input.value.trim();
  if (!text) return;
  addPlayerMsg(text);
  input.value = '';
  // NPC might respond
  setTimeout(function() {
    if (Math.random() > 0.4) {
      var npc = NPC_DATA[Math.floor(Math.random() * NPC_DATA.length)];
      var responses = ['haha', 'nice!', 'totally agree', 'lol', 'üëç', 'for real', 'same', 'cool!', 'interesting'];
      addNpcMsg(npc.name, npc.color, responses[Math.floor(Math.random() * responses.length)]);
    }
  }, 1500 + Math.random() * 3000);
}

// ==================== SCENE ====================
function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0a0a0f);

  camera = new THREE.PerspectiveCamera(70, (window.innerWidth - 320) / window.innerHeight, 0.1, 100);
  camera.position.set(0, 1.6, 4);

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth - 320, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  document.body.insertBefore(renderer.domElement, document.body.firstChild);

  clock = new THREE.Clock();

  // Lights ‚Äî warm living room ambiance
  var ambient = new THREE.AmbientLight(0x332211, 0.6);
  scene.add(ambient);
  var warm = new THREE.PointLight(0xff9944, 1.2, 20);
  warm.position.set(0, 2.8, 0);
  warm.castShadow = true;
  scene.add(warm);
  // Fireplace glow
  var fire = new THREE.PointLight(0xff4400, 0.8, 8);
  fire.position.set(0, 0.6, -5.8);
  scene.add(fire);
  // Accent light
  var accent = new THREE.PointLight(0x8b5cf6, 0.3, 10);
  accent.position.set(-4, 2, 2);
  scene.add(accent);

  buildRoom();
  createNPCs();

  // Events
  window.addEventListener('resize', function() {
    var w = window.innerWidth > 768 ? window.innerWidth - 320 : window.innerWidth;
    var h = window.innerWidth > 768 ? window.innerHeight : window.innerHeight * 0.6;
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
    renderer.setSize(w, h);
  });
  document.addEventListener('keydown', function(e) {
    keys[e.code] = true;
    if (e.code === 'KeyT' && gameStarted) {
      e.preventDefault();
      document.exitPointerLock();
      document.getElementById('chatInput').focus();
    }
    if (e.code === 'Enter' && document.activeElement === document.getElementById('chatInput')) {
      sendChat();
    }
  });
  document.addEventListener('keyup', function(e) { keys[e.code] = false; });
  document.addEventListener('mousemove', function(e) {
    if (!isPointerLocked) return;
    euler.y -= e.movementX * 0.002;
    euler.x -= e.movementY * 0.002;
    euler.x = Math.max(-1.2, Math.min(1.2, euler.x));
    camera.quaternion.setFromEuler(euler);
  });
  renderer.domElement.addEventListener('click', function() {
    if (gameStarted) renderer.domElement.requestPointerLock();
  });
  document.addEventListener('pointerlockchange', function() {
    isPointerLocked = (document.pointerLockElement === renderer.domElement);
  });
  renderer.render(scene, camera);
}

function buildRoom() {
  var room = 12, h = 3.2;
  var floorMat = new THREE.MeshStandardMaterial({ color: 0x3d2b1f, roughness: 0.8 });
  var wallMat = new THREE.MeshStandardMaterial({ color: 0x2a2035, roughness: 0.9 });
  var ceilMat = new THREE.MeshStandardMaterial({ color: 0x1a1520, roughness: 0.95 });

  // Floor
  var floor = new THREE.Mesh(new THREE.PlaneGeometry(room, room), floorMat);
  floor.rotation.x = -Math.PI / 2; floor.receiveShadow = true;
  scene.add(floor);

  // Ceiling
  var ceil = new THREE.Mesh(new THREE.PlaneGeometry(room, room), ceilMat);
  ceil.rotation.x = Math.PI / 2; ceil.position.y = h;
  scene.add(ceil);

  // Walls
  var addWall = function(w, ht, x, y, z, ry) {
    var wall = new THREE.Mesh(new THREE.PlaneGeometry(w, ht), wallMat);
    wall.position.set(x, y, z);
    wall.rotation.y = ry || 0;
    wall.receiveShadow = true;
    scene.add(wall);
  };
  addWall(room, h, 0, h/2, -room/2, 0);        // back
  addWall(room, h, 0, h/2, room/2, Math.PI);    // front
  addWall(room, h, -room/2, h/2, 0, Math.PI/2); // left
  addWall(room, h, room/2, h/2, 0, -Math.PI/2); // right

  // Rug
  var rug = new THREE.Mesh(new THREE.PlaneGeometry(4, 3), new THREE.MeshStandardMaterial({ color: 0x6b1d1d, roughness: 0.95 }));
  rug.rotation.x = -Math.PI / 2; rug.position.set(0, 0.01, 0);
  scene.add(rug);

  // Sofa ‚Äî main
  addBox(3, 0.8, 1.2, 0x4a3060, 0, 0.4, -2.5);
  // Sofa back
  addBox(3, 0.6, 0.15, 0x3d2550, 0, 0.9, -3.05);
  // Sofa arms
  addBox(0.15, 0.5, 1.2, 0x3d2550, -1.5, 0.55, -2.5);
  addBox(0.15, 0.5, 1.2, 0x3d2550, 1.5, 0.55, -2.5);
  // Sofa cushions
  addBox(0.85, 0.15, 0.9, 0x6b4090, -0.9, 0.85, -2.4);
  addBox(0.85, 0.15, 0.9, 0x6b4090, 0, 0.85, -2.4);
  addBox(0.85, 0.15, 0.9, 0x6b4090, 0.9, 0.85, -2.4);

  // Coffee table
  addBox(1.6, 0.06, 0.8, 0x5c3a1e, 0, 0.42, -0.5);
  addBox(0.08, 0.42, 0.08, 0x4a2e15, -0.7, 0.21, -0.1);
  addBox(0.08, 0.42, 0.08, 0x4a2e15, 0.7, 0.21, -0.1);
  addBox(0.08, 0.42, 0.08, 0x4a2e15, -0.7, 0.21, -0.85);
  addBox(0.08, 0.42, 0.08, 0x4a2e15, 0.7, 0.21, -0.85);

  // Armchair left
  addBox(1, 0.7, 1, 0x3d5030, -4, 0.35, -1);
  addBox(1, 0.5, 0.12, 0x2d4020, -4, 0.7, -1.44);
  addBox(0.12, 0.4, 1, 0x2d4020, -4.5, 0.5, -1);
  addBox(0.12, 0.4, 1, 0x2d4020, -3.5, 0.5, -1);

  // Fireplace ‚Äî back wall
  addBox(3, 2, 0.4, 0x1a1520, 0, 1, -5.7);
  // Mantle
  addBox(3.4, 0.1, 0.6, 0x4a3525, 0, 1.8, -5.6);
  // Fire opening
  addBox(1.6, 1, 0.1, 0x0a0508, 0, 0.5, -5.49);
  // Embers glow (small boxes)
  addBox(0.3, 0.08, 0.15, 0xff4400, -0.3, 0.08, -5.35, true);
  addBox(0.2, 0.06, 0.12, 0xff6600, 0.2, 0.06, -5.38, true);
  addBox(0.25, 0.07, 0.14, 0xff3300, 0, 0.1, -5.32, true);

  // Bookshelf ‚Äî left wall
  addBox(0.4, 2.5, 2.5, 0x3d2b1f, -5.7, 1.25, -2);
  // Shelves
  for (var s = 0; s < 5; s++) {
    addBox(0.35, 0.04, 2.4, 0x4a3525, -5.68, 0.3 + s * 0.55, -2);
    // Books on shelves
    for (var b = 0; b < 4; b++) {
      var bookColor = [0x8b2020, 0x204080, 0x206040, 0x804020][b];
      addBox(0.25, 0.35, 0.12, bookColor, -5.55, 0.5 + s * 0.55, -2.8 + b * 0.5);
    }
  }

  // TV area ‚Äî right wall
  addBox(0.08, 1.2, 2, 0x111118, 5.7, 1.4, -1);
  // TV screen (emissive)
  var tvScreen = new THREE.Mesh(
    new THREE.PlaneGeometry(1.8, 1),
    new THREE.MeshStandardMaterial({ color: 0x102030, emissive: 0x102030, emissiveIntensity: 0.5 })
  );
  tvScreen.position.set(5.65, 1.4, -1);
  tvScreen.rotation.y = -Math.PI / 2;
  scene.add(tvScreen);
  // TV stand
  addBox(0.5, 0.6, 1.5, 0x2a2035, 5.4, 0.3, -1);

  // Lamp
  addBox(0.08, 1.5, 0.08, 0xb8a080, 4, 0.75, 2);
  addBox(0.4, 0.3, 0.4, 0xf5deb3, 4, 1.6, 2, true);

  // Plant
  addBox(0.35, 0.35, 0.35, 0x3d2b1f, -3, 0.175, 4.5);
  // Plant foliage
  var plantGeo = new THREE.SphereGeometry(0.45, 8, 8);
  var plantMat = new THREE.MeshStandardMaterial({ color: 0x2d6b30 });
  var plant = new THREE.Mesh(plantGeo, plantMat);
  plant.position.set(-3, 0.7, 4.5);
  scene.add(plant);
}

function addBox(w, h, d, color, x, y, z, emissive) {
  var mat = new THREE.MeshStandardMaterial({
    color: color,
    roughness: 0.85,
    metalness: 0.05
  });
  if (emissive) {
    mat.emissive = new THREE.Color(color);
    mat.emissiveIntensity = 0.8;
  }
  var mesh = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), mat);
  mesh.position.set(x, y, z);
  mesh.castShadow = true;
  mesh.receiveShadow = true;
  scene.add(mesh);
  return mesh;
}

// ==================== NPCs ====================
function createNPCs() {
  NPC_DATA.forEach(function(data, i) {
    var color = new THREE.Color(data.color);
    // Body
    var body = new THREE.Mesh(
      new THREE.CylinderGeometry(0.2, 0.22, 1, 8),
      new THREE.MeshStandardMaterial({ color: color })
    );
    // Head
    var head = new THREE.Mesh(
      new THREE.SphereGeometry(0.18, 8, 8),
      new THREE.MeshStandardMaterial({ color: 0xffcc99 })
    );
    head.position.y = 0.7;
    body.add(head);

    // Name tag
    var canvas = document.createElement('canvas');
    canvas.width = 128; canvas.height = 32;
    var ctx = canvas.getContext('2d');
    ctx.font = 'bold 18px sans-serif';
    ctx.fillStyle = data.color;
    ctx.textAlign = 'center';
    ctx.fillText(data.name, 64, 22);
    var tex = new THREE.CanvasTexture(canvas);
    var sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex, transparent: true }));
    sprite.position.y = 1;
    sprite.scale.set(1.2, 0.3, 1);
    body.add(sprite);

    var positions = [
      new THREE.Vector3(-2, 0.5, 1),
      new THREE.Vector3(2, 0.5, 2),
      new THREE.Vector3(3, 0.5, -3)
    ];
    body.position.copy(positions[i]);

    scene.add(body);
    npcs.push({
      mesh: body,
      data: data,
      target: positions[i].clone(),
      timer: Math.random() * 5,
      chatTimer: 5 + Math.random() * 15,
      baseY: 0.5
    });
  });
}

// ==================== GAME LOOP ====================
function enterRoom() {
  gameStarted = true;
  document.getElementById('splash').classList.add('hidden');
  document.getElementById('hud').classList.remove('hidden');
  document.getElementById('crosshair').classList.remove('hidden');
  document.getElementById('chatPanel').classList.remove('hidden');
  document.getElementById('backLink').classList.remove('hidden');
  renderer.domElement.requestPointerLock();
  addSystemMsg('Welcome to the Living Room! üõãÔ∏è');
  addSystemMsg('Click the 3D view to look around. Press T to chat.');
  NPC_DATA.forEach(function(d) {
    addSystemMsg(d.name + ' is here.');
  });
  animate();
}

function animate() {
  requestAnimationFrame(animate);
  var dt = Math.min(clock.getDelta(), 0.05);

  // Movement
  if (isPointerLocked) {
    var speed = 3 * dt;
    var forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
    forward.y = 0; forward.normalize();
    var right = new THREE.Vector3(1, 0, 0).applyQuaternion(camera.quaternion);
    right.y = 0; right.normalize();

    var move = new THREE.Vector3();
    if (keys['KeyW']) move.add(forward.clone().multiplyScalar(speed));
    if (keys['KeyS']) move.add(forward.clone().multiplyScalar(-speed));
    if (keys['KeyA']) move.add(right.clone().multiplyScalar(-speed));
    if (keys['KeyD']) move.add(right.clone().multiplyScalar(speed));

    camera.position.add(move);
    // Room bounds
    camera.position.x = Math.max(-5.2, Math.min(5.2, camera.position.x));
    camera.position.z = Math.max(-5.2, Math.min(5.2, camera.position.z));
    camera.position.y = 1.6;
  }

  // NPC wandering
  npcs.forEach(function(npc) {
    npc.timer -= dt;
    if (npc.timer <= 0) {
      npc.target.set(
        -3 + Math.random() * 6,
        npc.baseY,
        -3 + Math.random() * 6
      );
      npc.timer = 3 + Math.random() * 5;
    }
    var dir = npc.target.clone().sub(npc.mesh.position);
    if (dir.length() > 0.2) {
      dir.normalize().multiplyScalar(0.6 * dt);
      dir.y = 0;
      npc.mesh.position.add(dir);
      npc.mesh.rotation.y = Math.atan2(dir.x, dir.z);
    }
    // Idle bob
    npc.mesh.position.y = npc.baseY + Math.sin(Date.now() * 0.003 + npcs.indexOf(npc)) * 0.02;

    // NPC chat
    npc.chatTimer -= dt;
    if (npc.chatTimer <= 0) {
      var msg = npc.data.msgs[Math.floor(Math.random() * npc.data.msgs.length)];
      addNpcMsg(npc.data.name, npc.data.color, msg);
      npc.chatTimer = 8 + Math.random() * 20;
    }
  });

  // Fire flicker
  scene.children.forEach(function(c) {
    if (c.isPointLight && c.color.r > 0.9 && c.position.z < -5) {
      c.intensity = 0.6 + Math.random() * 0.4;
    }
  });

  renderer.render(scene, camera);
}

// Init
init();
</script>
</body>
</html>